<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Miro's Inventory</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
</head>
<style>
    body {
        font-family: 'Inter', sans-serif;
    }
</style>

<body class="p-4">
    <div class="container mx-auto px-4">
        <div class="d-flex align-items-center mb-4">
            <h1 class="text-2xl font-semibold me-3 mb-0">Miro's Inventory</h1>
            <img src="https://scontent-man2-1.xx.fbcdn.net/v/t39.30808-6/383202602_1604733666598950_3583765443070314613_n.jpg?_nc_cat=109&ccb=1-7&_nc_sid=6ee11a&_nc_ohc=PCSqRKYZqwQQ7kNvwHLbqX5&_nc_oc=AdliDbbw4R3jZAau1jo836DxGD9CPtt_wpfzo9YB1FTBIvp7k2d3F_-9huVuVtC99CQ&_nc_zt=23&_nc_ht=scontent-man2-1.xx&_nc_gid=GDUoWXdSBdAOrIfxNtdceA&oh=00_AfMw62bnUsTyGA3ZgQZSzMDvO1QU5gX6DgDajXqROCVGQQ&oe=6869155D"
                alt="Miro" class="rounded-circle" style="width:6rem;height:6rem;object-fit:cover;">
        </div>
        <!-- Navigation Buttons -->
        <button id="productsBtn" class="btn btn-outline-primary mb-4 px-4 py-2">üì¶ Products Page</button>
        <button id="dashboardBtn" class="btn btn-outline-success mb-4 px-4 py-2">üìä Open Dashboard</button>
        <button id="linksBtn" class="btn btn-outline-info mb-4 px-4 py-2">üîó Links Page</button>
        <button id="themeToggle" class="btn btn-outline-secondary mb-4 px-4 py-2">üåì Toggle Theme</button>


        <!-- DASHBOARD PAGE -->
        <div id="dashboardPage" style="display: none;">
            <h2>üìä Inventory Dashboard</h2>
            <ul class="list-group mb-4">
                <li class="list-group-item">Total Products: <strong id="dashTotalProducts">0</strong></li>
                <li class="list-group-item">Total Units in Stock: <strong id="dashTotalUnits">0</strong></li>
                <li class="list-group-item">Total Stock Value: <strong id="dashStockValue">0</strong></li>
                <li class="list-group-item">Total Profit: <strong id="dashProfit">0</strong></li>
                <li class="list-group-item">Total Sales: <strong id="dashSalesCount">0</strong></li>
                <li class="list-group-item">Total Sales Revenue: <strong id="dashRevenue">0</strong></li>
                <li class="list-group-item">Money Spent: <strong id="dashSpent">0</strong></li>
            </ul>

            <h4>Sales Log</h4>
            <div class="table-responsive">
                <table class="table table-striped table-hover table-bordered">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Product</th>
                            <th>Units</th>
                            <th>Sell Price</th>
                            <th>Cost</th>
                            <th>New Cost</th>
                            <th>Profit</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="dashboardSalesLog"></tbody>
                </table>
            </div>
            <nav>
                <ul class="pagination" id="salesPagination"></ul>
            </nav>

            <button id="closeDashboard" class="btn btn-secondary">‚¨ÖÔ∏è Back</button>

            <div class="mt-5">
                <h3>This is to export the sales log as a CSV file</h3>
                <button id="exportCsv" class="btn btn-outline-primary me-2">‚¨áÔ∏è Export CSV</button>
            </div>
        </div>
        <!-- MAIN PAGE -->
        <div id="mainPage">
            <h2>Add Product</h2>
            <form id="addProductForm" class="mb-4">
                <div class="mb-3">
                    <input type="text" id="name" class="form-control" placeholder="Product Name" required />
                </div>
                <div class="mb-3">
                    <input type="number" id="quantity" class="form-control" placeholder="Quantity" required />
                </div>
                <div class="mb-3">
                    <input type="number" id="price" class="form-control" placeholder="Selling Price per Unit"
                        required />
                </div>
                <div class="mb-3">
                    <input type="number" id="cost" class="form-control" placeholder="Purchase Cost per Unit" required />
                </div>
                <div class="mb-3">
                    <select id="type" class="form-select" required>
                        <option value="Booster Packs">Booster Packs</option>
                        <option value="Booster Boxes">Booster Boxes</option>
                        <option value="Elite Trainer Boxes">Elite Trainer Boxes</option>
                        <option value="Mini Tins">Mini Tins</option>
                        <option value="Graded Cards">Graded Cards</option>
                        <option value="Single Cards">Single Cards</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div class="mb-3">
                    <input type="text" id="image" class="form-control" placeholder="Image URL" />
                </div>
                <button type="submit" class="btn btn-primary">Add Product</button>
            </form>
            <h3>
                Total Profit: ¬£<span id="totalProfit">0</span> |
                Total Stock Value: ¬£<span id="totalStockValue">0</span>
            </h3>
            <!-- Search Bar -->
            <div class="row g-3 mb-3">
                <div class="col-md-4">
                    <input type="text" id="searchInput" class="form-control" placeholder="üîç Search by product name...">
                </div>
                <div class="col-md-4">
                    <select id="groupSelect" class="form-select">
                        <option value="All">All Types</option>
                        <option value="Booster Packs">Booster Packs</option>
                        <option value="Booster Boxes">Booster Boxes</option>
                        <option value="Elite Trainer Boxes">Elite Trainer Boxes</option>
                        <option value="Mini Tins">Mini Tins</option>
                        <option value="Graded Cards">Graded Cards</option>
                        <option value="Single Cards">Single Cards</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <select id="sortSelect" class="form-select">
                        <option value="name-asc">Name (A‚ÄìZ)</option>
                        <option value="name-desc">Name (Z‚ÄìA)</option>
                        <option value="quantity-desc">Quantity (High ‚Üí Low)</option>
                        <option value="quantity-asc">Quantity (Low ‚Üí High)</option>
                        <option value="price-desc">Price (High ‚Üí Low)</option>
                        <option value="price-asc">Price (Low ‚Üí High)</option>
                        <option value="cost-desc">Cost (High ‚Üí Low)</option>
                        <option value="cost-asc">Cost (Low ‚Üí High)</option>
                    </select>
                </div>
            </div>
            <div class="row g-3 mb-3">
                <div class="col-md-4">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="showOutOfStock" checked>
                        <label class="form-check-label" for="showOutOfStock">Show Out of Stock</label>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="showLowStock" checked>
                        <label class="form-check-label" for="showLowStock">Show Low Stock</label>
                    </div>
                </div>
                <div class="col-md-4">
                    <button id="showAllBtn" class="btn btn-secondary w-100">Show All</button>
                </div>
            </div>
            <div class="mb-4">
                <div style="width:8rem;">
                    <select id="perPageSelect" class="form-select">
                        <option value="10">10</option>
                        <option value="20">20</option>
                        <option value="50">50</option>
                        <option value="100">100</option>
                        <option value="all">All</option>
                    </select>
                </div>
            </div>
            <h2>Products</h2>
            <div id="products" class="row g-4 row-cols-1 row-cols-sm-2 row-cols-lg-3"></div>
            <nav>
                <ul class="pagination" id="productsPagination"></ul>
            </nav>
        </div>

        <!-- SELL PAGE -->
        <div id="sellPage" style="display: none;">
            <h2>Sell Product</h2>
            <div class="mb-3">
                <label>Product Name:</label>
                <input type="text" id="sellName" class="form-control" readonly />
            </div>
            <div class="mb-3">
                <label>In Stock:</label>
                <input type="number" id="sellStock" class="form-control" readonly />
            </div>
            <div class="mb-3">
                <label>Purchase Cost per Unit:</label>
                <input type="number" id="sellCost" class="form-control" readonly />
            </div>
            <div class="form-check mb-3">
                <input class="form-check-input" type="checkbox" id="overrideCostCheck">
                <label class="form-check-label" for="overrideCostCheck">Use different purchase price for this
                    sale</label>
            </div>
            <div class="mb-3">
                <label>New Purchase Price per Unit:</label>
                <input type="number" id="overrideCost" class="form-control" placeholder="New purchase price" disabled />
            </div>
            <div class="mb-3">
                <label>Units to Sell:</label>
                <input type="number" id="sellUnits" class="form-control" placeholder="Units to sell" />
            </div>
            <div class="mb-3">
                <label>Selling Price per Unit:</label>
                <input type="number" id="sellPrice" class="form-control" placeholder="Selling price per unit" />
            </div>
            <button id="confirmSell" class="btn btn-success">Confirm Sale</button>
            <button id="cancelSell" class="btn btn-secondary">Cancel</button>
        </div>

        <!-- EDIT PAGE -->
        <div id="editPage" style="display: none;">
            <h2>Edit Product</h2>
            <form id="editProductForm" class="mb-4">
                <div class="mb-3">
                    <label>Name:</label>
                    <input type="text" id="editName" class="form-control" />
                </div>
                <div class="mb-3">
                    <label>Selling Price:</label>
                    <input type="number" id="editPrice" class="form-control" />
                </div>
                <div class="mb-3">
                    <label>Purchase Cost:</label>
                    <input type="number" id="editCost" class="form-control" />
                </div>
                <div class="mb-3">
                    <label>Quantity:</label>
                    <input type="number" id="editQuantity" class="form-control" />
                </div>
                <div class="mb-3">
                    <label>Type:</label>
                    <select id="editType" class="form-select">
                        <option value="Booster Packs">Booster Packs</option>
                        <option value="Booster Boxes">Booster Boxes</option>
                        <option value="Elite Trainer Boxes">Elite Trainer Boxes</option>
                        <option value="Mini Tins">Mini Tins</option>
                        <option value="Graded Cards">Graded Cards</option>
                        <option value="Single Cards">Single Cards</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label>Image URL:</label>
                    <input type="text" id="editImage" class="form-control" />
                </div>
                <button type="submit" class="btn btn-success">Save Changes</button>
                <button type="button" id="cancelEdit" class="btn btn-secondary">Cancel</button>
            </form>
        </div>

        <!-- LINKS PAGE -->
        <div id="linksPage" style="display: none;">
            <h1>Useful Links</h1>
            <ul id="linksList" class="list-group mb-4"></ul>
            <hr class="my-4">
            <h2>Add Link</h2>
            <form id="addLinkForm" class="mb-4">
                <div class="mb-3">
                    <input type="text" id="linkName" class="form-control" placeholder="Name" required />
                </div>
                <div class="mb-3">
                    <input type="url" id="linkUrl" class="form-control" placeholder="URL" required />
                </div>
                <button type="submit" class="btn btn-primary">Add Link</button>
            </form>
            <hr class="my-4">
            <h2>All Links</h2>
            <div id="allLinks"></div>
        </div>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getDatabase, ref, push, onValue, update, remove, get } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js";

        // -------------------------------------------------------------------------
        // Element references
        // -------------------------------------------------------------------------
        const pages = {
            main: document.getElementById("mainPage"),
            sell: document.getElementById("sellPage"),
            edit: document.getElementById("editPage"),
            links: document.getElementById("linksPage"),
            dashboard: document.getElementById("dashboardPage")
        };

        // keep existing variable names for compatibility
        const { main: mainPage, sell: sellPage, edit: editPage, links: linksPage, dashboard: dashboardPage } = pages;

        const nav = {
            products: document.getElementById("productsBtn"),
            links: document.getElementById("linksBtn")
        };

        const themeToggleBtn = document.getElementById("themeToggle");

        function applyTheme(theme) {
            document.documentElement.setAttribute('data-bs-theme', theme);
            localStorage.setItem('theme', theme);
        }
        const storedTheme = localStorage.getItem('theme') || 'light';
        applyTheme(storedTheme);
        themeToggleBtn.addEventListener('click', () => {
            const current = document.documentElement.getAttribute('data-bs-theme');
            const next = current === 'dark' ? 'light' : 'dark';
            applyTheme(next);
        });
        // Utility to switch between pages
        function showPage(page) {
            Object.values(pages).forEach(p => p.style.display = "none");
            page.style.display = "block";
        }

        // Navigation events  
        nav.products.addEventListener("click", () => showPage(pages.main));
        nav.links.addEventListener("click", () => showPage(pages.links));


        // -----------------------------------------------------------------
        // Firebase setup
        // -----------------------------------------------------------------
        const firebaseConfig = {
            apiKey: "",
            authDomain: "",
            databaseURL: "",
            projectId: "",
            storageBucket: "",
            messagingSenderId: "",
            appId: "",
            measurementId: ""
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const productsRef = ref(db, "products");
        const salesRef = ref(db, "sales");


        // -----------------------------------------------------------------
        // UI controls
        // -----------------------------------------------------------------
        const searchInput = document.getElementById("searchInput");
        const sortSelect = document.getElementById("sortSelect");
        const groupSelect = document.getElementById("groupSelect");
        const perPageSelect = document.getElementById("perPageSelect");
        const productsPagination = document.getElementById("productsPagination");
        const overrideCostCheck = document.getElementById("overrideCostCheck");
        const overrideCostInput = document.getElementById("overrideCost");
        const showOutOfStockCheck = document.getElementById("showOutOfStock");
        const showLowStockCheck = document.getElementById("showLowStock");
        const showAllBtn = document.getElementById("showAllBtn");

        // Toggle custom cost field on the sell page
        overrideCostCheck.addEventListener("change", () => {
            overrideCostInput.disabled = !overrideCostCheck.checked;
            if (!overrideCostCheck.checked) {
                overrideCostInput.value = "";
            }
        });

        // -----------------------------------------------------------------
        // Application state
        // -----------------------------------------------------------------
        let currentSellKey = null;
        let currentEditKey = null;

        const LOW_STOCK_THRESHOLD = 3;

        let showOutOfStock = true;
        let showLowStock = true;

        let allProducts = [];
        let currentProductPage = 1;
        let productsPerPage = 10;

        const form = document.getElementById("addProductForm");
        form.addEventListener("submit", (e) => {
            e.preventDefault();
            const product = {
                name: document.getElementById("name").value || "Unnamed",
                quantity: Number(document.getElementById("quantity").value) || 0,
                price: Number(document.getElementById("price").value) || 0,
                cost: Number(document.getElementById("cost").value) || 0,
                type: document.getElementById("type").value || "Other",
                image: document.getElementById("image").value || "https://upload.wikimedia.org/wikipedia/commons/thumb/0/06/Item_Industrietechnik_und_Maschinenbau_logo.svg/2560px-Item_Industrietechnik_und_Maschinenbau_logo.svg.png",
                profit: 0
            };
            push(productsRef, product);
            form.reset();
        });

        // Render list of products with filtering, sorting and pagination
        function renderProducts() {
            const filter = searchInput.value.toLowerCase();
            const sortBy = sortSelect.value;
            const groupBy = groupSelect.value;

            const productsDiv = document.getElementById("products");
            let totalProfit = 0;
            let totalStockValue = 0;

            let visible = allProducts.filter(({ val }) => {
                if (!val.name.toLowerCase().includes(filter)) return false;
                if (groupBy !== "All" && (val.type || "Other") !== groupBy) return false;
                if (!showOutOfStock && val.quantity === 0) return false;
                if (!showLowStock && val.quantity > 0 && val.quantity < LOW_STOCK_THRESHOLD) return false;
                return true;
            });

            visible.sort((a, b) => {
                const pA = a.val;
                const pB = b.val;

                switch (sortBy) {
                    case "name-asc":
                        return pA.name.localeCompare(pB.name);
                    case "name-desc":
                        return pB.name.localeCompare(pA.name);
                    case "quantity-desc":
                        return pB.quantity - pA.quantity;
                    case "quantity-asc":
                        return pA.quantity - pB.quantity;
                    case "price-desc":
                        return pB.price - pA.price;
                    case "price-asc":
                        return pA.price - pB.price;
                    case "cost-desc":
                        return pB.cost - pA.cost;
                    case "cost-asc":
                        return pA.cost - pB.cost;
                    default:
                        return 0;
                }
            });

            const totalPages = productsPerPage === Infinity ? 1 : Math.ceil(visible.length / productsPerPage);
            if (currentProductPage > totalPages) currentProductPage = totalPages || 1;

            const start = productsPerPage === Infinity ? 0 : (currentProductPage - 1) * productsPerPage;
            const end = productsPerPage === Infinity ? visible.length : start + productsPerPage;

            productsDiv.innerHTML = "";

            visible.slice(start, end).forEach(({ key, val: p }) => {
                totalProfit += p.profit || 0;
                totalStockValue += (p.quantity * p.cost) || 0;

                const lowStockBadge = (p.quantity > 0 && p.quantity < LOW_STOCK_THRESHOLD)
                    ? `<span class="badge bg-danger">Low Stock</span>` : ``;
                const outOfStockBadge = p.quantity === 0
                    ? `<span class="badge bg-dark">Out of Stock</span>` : ``;

                productsDiv.innerHTML += `
        <div class="bg-white rounded shadow p-4 d-flex flex-column">
            <img src="${p.image}" class="w-100 mb-2 rounded" style="height:12rem;object-fit:contain;background-color:#f8f9fa;" alt="${p.name}" onerror="this.src='https://upload.wikimedia.org/wikipedia/commons/thumb/0/06/Item_Industrietechnik_und_Maschinenbau_logo.svg/2560px-Item_Industrietechnik_und_Maschinenbau_logo.svg.png'">
            <div class="flex-grow-1">
              <h5 class="fs-5 fw-semibold mb-1">${p.name} ${lowStockBadge} ${outOfStockBadge}</h5>
              <p class="mb-2 small">
                Type: ${p.type || 'Other'} <br/>
                Quantity: ${p.quantity} <br/>
                Price: ¬£${p.price} <br/>
                Cost: ¬£${p.cost} <br/>
                Profit: ¬£${p.profit}
              </p>
            </div>
            <div class="mt-auto">
              <div class="d-flex gap-2 mb-2">
                <button class="btn btn-success btn-sm flex-grow-1" onclick="changeQuantity('${key}', 1)">+1</button>
                <button class="btn btn-warning btn-sm flex-grow-1" onclick="changeQuantity('${key}', -1)">-1</button>
              </div>
              <div class="d-flex gap-2">
                <button class="btn btn-primary btn-sm flex-grow-1" onclick="startSell('${key}')">Sell</button>
                <button class="btn btn-secondary btn-sm flex-grow-1" onclick="startEdit('${key}')">Edit</button>
                <button class="btn btn-danger btn-sm flex-grow-1" onclick="deleteProduct('${key}')">Delete</button>
              </div>
            </div>
        </div>
      `;
            });

            document.getElementById("totalProfit").innerText = totalProfit.toFixed(2);
            document.getElementById("totalStockValue").innerText = totalStockValue.toFixed(2);

            renderProductsPagination(totalPages);
        }

        // Listen for product changes in Firebase
        onValue(productsRef, (snapshot) => {
            allProducts = [];
            snapshot.forEach((child) => {
                allProducts.push({ key: child.key, val: child.val() });
            });
            renderProducts();
        });

        // Filter and sort controls
        searchInput.addEventListener("input", () => { currentProductPage = 1; renderProducts(); });
        sortSelect.addEventListener("change", () => { currentProductPage = 1; renderProducts(); });
        groupSelect.addEventListener("change", () => { currentProductPage = 1; renderProducts(); });
        // Pagination and visibility controls
        perPageSelect.addEventListener("change", () => {
            const val = perPageSelect.value;
            productsPerPage = val === "all" ? Infinity : Number(val);
            currentProductPage = 1;
            renderProducts();
        });
        // Visibility toggles
        showOutOfStockCheck.addEventListener("change", () => {
            showOutOfStock = showOutOfStockCheck.checked;
            currentProductPage = 1;
            renderProducts();
        });
        showLowStockCheck.addEventListener("change", () => {
            showLowStock = showLowStockCheck.checked;
            currentProductPage = 1;
            renderProducts();
        });
        showAllBtn.addEventListener("click", () => {
            showOutOfStockCheck.checked = true;
            showLowStockCheck.checked = true;
            showOutOfStock = true;
            showLowStock = true;
            currentProductPage = 1;
            renderProducts();
        });

        function renderProductsPagination(totalPages) {
            productsPagination.innerHTML = "";
            if (productsPerPage === Infinity || totalPages <= 1) return;
            if (currentProductPage > 1) {
                productsPagination.innerHTML += `<li class="page-item"><a class="page-link" href="#" onclick="gotoProdPage(${currentProductPage - 1})">Previous</a></li>`;
            }
            for (let i = 1; i <= totalPages; i++) {
                productsPagination.innerHTML += `<li class="page-item ${i === currentProductPage ? 'active' : ''}"><a class="page-link" href="#" onclick="gotoProdPage(${i})">${i}</a></li>`;
            }
            if (currentProductPage < totalPages) {
                productsPagination.innerHTML += `<li class="page-item"><a class="page-link" href="#" onclick="gotoProdPage(${currentProductPage + 1})">Next</a></li>`;
            }
        }

        // Navigate product pages
        window.gotoProdPage = function (page) {
            currentProductPage = page;
            renderProducts();
        };

        // Increment or decrement product quantity
        window.changeQuantity = function (key, delta) {
            const productRef = ref(db, "products/" + key);
            onValue(productRef, (snapshot) => {
                const current = snapshot.val();
                let newQty = current.quantity + delta;
                if (newQty < 0) newQty = 0;
                update(productRef, { quantity: newQty });
            }, { onlyOnce: true });
        }

        // Open sell page for a product
        window.startSell = function (key) {
            const productRef = ref(db, "products/" + key);
            onValue(productRef, (snapshot) => {
                const p = snapshot.val();
                currentSellKey = key;
                document.getElementById("sellName").value = p.name;
                document.getElementById("sellStock").value = p.quantity;
                document.getElementById("sellCost").value = p.cost;
                document.getElementById("sellUnits").value = "";
                document.getElementById("sellPrice").value = "";
                document.getElementById("overrideCostCheck").checked = false;
                const overrideField = document.getElementById("overrideCost");
                overrideField.value = "";
                overrideField.disabled = true;
                showPage(pages.sell);
            }, { onlyOnce: true });
        }

        // Open edit page for a product
        window.startEdit = function (key) {
            const productRef = ref(db, "products/" + key);
            onValue(productRef, (snapshot) => {
                const p = snapshot.val();
                currentEditKey = key;
                document.getElementById("editName").value = p.name || "";
                document.getElementById("editPrice").value = p.price || "";
                document.getElementById("editCost").value = p.cost || "";
                document.getElementById("editQuantity").value = p.quantity || 0;
                document.getElementById("editType").value = p.type || "Other";
                document.getElementById("editImage").value = p.image || "";
                showPage(pages.edit);
            }, { onlyOnce: true });
        }

        // Save edited product details
        document.getElementById("editProductForm").addEventListener("submit", (e) => {
            e.preventDefault();
            if (!currentEditKey) return;

            const newName = document.getElementById("editName").value.trim();
            const newPrice = document.getElementById("editPrice").value.trim();
            const newCost = document.getElementById("editCost").value.trim();
            const newQty = document.getElementById("editQuantity").value.trim();
            const newType = document.getElementById("editType").value;
            const newImage = document.getElementById("editImage").value.trim();

            const productRef = ref(db, "products/" + currentEditKey);
            onValue(productRef, (snapshot) => {
                const current = snapshot.val();
                update(productRef, {
                    name: newName !== "" ? newName : (current.name || "Unnamed"),
                    price: newPrice !== "" ? Number(newPrice) : (current.price || 0),
                    cost: newCost !== "" ? Number(newCost) : (current.cost || 0),
                    quantity: newQty !== "" ? Number(newQty) : (current.quantity || 0),
                    type: newType || (current.type || "Other"),
                    image: newImage !== "" ? newImage : (current.image || "https://via.placeholder.com/150")
                });
            }, { onlyOnce: true });

            showPage(pages.main);
            currentEditKey = null;
        });

        // Abort editing
        document.getElementById("cancelEdit").addEventListener("click", () => {
            showPage(pages.main);
            currentEditKey = null;
        });

        // Complete sale transaction
        document.getElementById("confirmSell").addEventListener("click", () => {
            const units = Number(document.getElementById("sellUnits").value);
            const sellPrice = Number(document.getElementById("sellPrice").value);
            const useOverride = overrideCostCheck.checked;
            const overrideValue = Number(overrideCostInput.value);
            if (units <= 0 || sellPrice <= 0) {
                showToast("Please enter valid numbers.");
                return;
            }
            const productRef = ref(db, "products/" + currentSellKey);
            onValue(productRef, (snapshot) => {
                const p = snapshot.val();
                if (units > p.quantity) {
                    showToast("Not enough stock.");
                    return;
                }
                const newQty = p.quantity - units;
                const costForSale = useOverride && overrideValue > 0 ? overrideValue : p.cost;
                const profitFromSale = (sellPrice - costForSale) * units;
                const newProfit = (p.profit || 0) + profitFromSale;

                update(productRef, {
                    quantity: newQty,
                    profit: newProfit
                });

                push(salesRef, {
                    product: p.name,
                    units: units,
                    sellPrice: sellPrice,
                    cost: p.cost,
                    newCost: useOverride && overrideValue > 0 ? overrideValue : null,
                    profit: profitFromSale,
                    date: new Date().toLocaleString()
                });

                showPage(pages.main);
                currentSellKey = null;
            }, { onlyOnce: true });
        });

        // Abort selling
        document.getElementById("cancelSell").addEventListener("click", () => {
            showPage(pages.main);
            currentSellKey = null;
        });

        // Remove a product and its sales history
        window.deleteProduct = function (key) {
            showConfirm("Delete this product? Deleting a product will also remove all associated sales.").then((ok) => {
                if (ok) {
                    remove(ref(db, "products/" + key));
                }
            });
        };

        // DASHBOARD LOGIC
        const dashboardSalesLog = document.getElementById("dashboardSalesLog");
        const salesPagination = document.getElementById("salesPagination");
        const dashboardBtn = document.getElementById("dashboardBtn");
        const closeDashboard = document.getElementById("closeDashboard");
        const exportCsvBtn = document.getElementById("exportCsv");

        let allSales = [];
        let currentPage = 1;
        const perPage = 20; // adjust as needed

        dashboardBtn.addEventListener("click", async () => {
            showPage(pages.dashboard);

            const productsSnap = await get(productsRef);
            const salesSnap = await get(salesRef);

            let prod = 0, units = 0, stockV = 0, profit = 0, sales = 0, rev = 0, spentSales = 0;

            productsSnap.forEach((c) => {
                const p = c.val();
                prod++;
                units += p.quantity;
                stockV += p.quantity * p.cost;
                profit += p.profit;
            });

            salesSnap.forEach((c) => {
                const s = c.val();
                sales++;
                rev += s.sellPrice * s.units;
                const costForSale = s.newCost && s.newCost > 0 ? s.newCost : s.cost;
                spentSales += costForSale * s.units;
            });

            const spent = stockV + spentSales;


            document.getElementById("dashTotalProducts").innerText = prod;
            document.getElementById("dashTotalUnits").innerText = units;
            document.getElementById("dashStockValue").innerText = "¬£" + stockV.toFixed(2);

            document.getElementById("dashProfit").innerText = "¬£" + profit.toFixed(2);
            document.getElementById("dashSalesCount").innerText = sales;
            document.getElementById("dashRevenue").innerText = "¬£" + rev.toFixed(2);
            document.getElementById("dashSpent").innerText = "¬£" + spent.toFixed(2);


            // Render logs with pagination
            allSales = [];
            salesSnap.forEach((c) => {
                allSales.push({ key: c.key, val: c.val() });
            });
            allSales.reverse();
            currentPage = 1;
            renderSalesPage();
        });

        closeDashboard.addEventListener("click", () => {
            showPage(pages.main);
        });

        exportCsvBtn.addEventListener("click", () => {
            const headers = ["Date", "Product", "Units", "Sell Price", "Cost", "New Cost", "Profit"];
            const rows = allSales.map(({ val }) => [val.date, val.product, val.units, val.sellPrice, val.cost, val.newCost || '', val.profit]);
            let csv = headers.join(',') + '\n';
            rows.forEach(r => { csv += r.join(',') + '\n'; });
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'sales.csv';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        });

        // Render sales log table
        function renderSalesPage() {
            const start = (currentPage - 1) * perPage;
            const end = start + perPage;
            dashboardSalesLog.innerHTML = "";

            allSales.slice(start, end).forEach(({ key, val: s }) => {
                const newCostDisp = s.newCost ? '¬£' + s.newCost : 'N/A';
                dashboardSalesLog.innerHTML += `<tr>
      <td>${s.date}</td>
      <td>${s.product}</td>
      <td>${s.units}</td>
      <td>¬£${s.sellPrice}</td>
      <td>¬£${s.cost}</td>
      <td>${newCostDisp}</td>
      <td>¬£${s.profit}</td>
      <td><button onclick="deleteSale('${key}')" class="btn btn-danger btn-sm">Delete</button></td>
    </tr>`;
            });

            renderPagination();
        }

        // Render pagination controls for sales log
        function renderPagination() {
            const totalPages = Math.ceil(allSales.length / perPage);
            salesPagination.innerHTML = "";

            if (currentPage > 1) {
                salesPagination.innerHTML += `<li class="page-item"><a class="page-link" href="#" onclick="gotoPage(${currentPage - 1})">Previous</a></li>`;
            }
            for (let i = 1; i <= totalPages; i++) {
                salesPagination.innerHTML += `<li class="page-item ${i === currentPage ? 'active' : ''}">
      <a class="page-link" href="#" onclick="gotoPage(${i})">${i}</a></li>`;
            }
            if (currentPage < totalPages) {
                salesPagination.innerHTML += `<li class="page-item"><a class="page-link" href="#" onclick="gotoPage(${currentPage + 1})">Next</a></li>`;
            }
        }

        // Navigate pages in sales log
        window.gotoPage = function (page) {
            currentPage = page;
            renderSalesPage();
        };

        // Remove sale record and revert inventory
        window.deleteSale = async function (key) {
            const ok = await showConfirm("Delete sale and revert?");
            if (!ok) return;

            const sSnap = await get(ref(db, "sales/" + key));
            const s = sSnap.val();

            const pSnap = await get(productsRef);
            pSnap.forEach((c) => {
                const p = c.val();
                if (p.name === s.product) {
                    update(ref(db, "products/" + c.key), {
                        quantity: p.quantity + s.units,
                        profit: (p.profit || 0) - s.profit
                    });
                }
            });
            await remove(ref(db, "sales/" + key));
            showToast("Sale removed and reverted.");
            dashboardBtn.click();
        };


    </script>

    <script>
        // -------------------------------------------------------------
        // Manage useful links using localStorage
        // -------------------------------------------------------------
        function getLinks() {
            return JSON.parse(localStorage.getItem('links') || '[]');
        }

        // Persist links to storage
        function saveLinks(links) {
            localStorage.setItem('links', JSON.stringify(links));
        }

        // Display all saved links and edit controls
        function renderLinks() {
            const linksList = document.getElementById('linksList');
            const allLinksDiv = document.getElementById('allLinks');
            const links = getLinks();
            linksList.innerHTML = '';
            allLinksDiv.innerHTML = '';
            links.forEach((link, index) => {
                const li = document.createElement('li');
                li.className = 'list-group-item';
                const a = document.createElement('a');
                a.href = link.url;
                a.target = '_blank';
                a.textContent = link.name;
                li.appendChild(a);
                linksList.appendChild(li);

                const div = document.createElement('div');
                div.className = 'mb-3';
                const nameInput = document.createElement('input');
                nameInput.value = link.name;
                nameInput.className = 'form-control mb-2';
                const urlInput = document.createElement('input');
                urlInput.value = link.url;
                urlInput.className = 'form-control mb-2';
                const saveBtn = document.createElement('button');
                saveBtn.className = 'btn btn-success btn-sm me-2';
                saveBtn.textContent = 'Save';
                saveBtn.onclick = () => {
                    links[index] = { name: nameInput.value, url: urlInput.value };
                    saveLinks(links);
                    renderLinks();
                };
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'btn btn-danger btn-sm';
                deleteBtn.textContent = 'Delete';
                deleteBtn.onclick = () => {
                    links.splice(index, 1);
                    saveLinks(links);
                    renderLinks();
                };
                div.appendChild(nameInput);
                div.appendChild(urlInput);
                div.appendChild(saveBtn);
                div.appendChild(deleteBtn);
                allLinksDiv.appendChild(div);
            });
        }

        // Add a new link
        document.getElementById('addLinkForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const name = document.getElementById('linkName').value;
            const url = document.getElementById('linkUrl').value;
            const links = getLinks();
            links.push({ name, url });
            saveLinks(links);
            document.getElementById('addLinkForm').reset();
            renderLinks();
        });

        // Initial render of saved links
        renderLinks();

        // ------------------------------------------
        // Toast helper
        // ------------------------------------------
        function showToast(message) {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = 'alert alert-success mb-2';
            toast.textContent = message;
            container.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        // ------------------------------------------
        // Confirm modal helper
        // ------------------------------------------
        function showConfirm(message) {
            return new Promise((resolve) => {
                const modal = document.getElementById('confirmModal');
                const msg = document.getElementById('confirmMessage');
                msg.textContent = message;
                modal.classList.remove('d-none');
                const ok = document.getElementById('confirmOk');
                const cancel = document.getElementById('confirmCancel');
                const cleanup = () => {
                    modal.classList.add('d-none');
                    ok.removeEventListener('click', onOk);
                    cancel.removeEventListener('click', onCancel);
                };
                const onOk = () => { cleanup(); resolve(true); };
                const onCancel = () => { cleanup(); resolve(false); };
                ok.addEventListener('click', onOk);
                cancel.addEventListener('click', onCancel);
            });
        }
    </script>

    <!-- Toasts -->
    <div id="toastContainer" class="position-fixed top-0 end-0 p-4" style="z-index:1055;"></div>

    <!-- Confirm Modal -->
    <div id="confirmModal"
        class="d-none position-fixed top-0 start-0 w-100 h-100 bg-black bg-opacity-50 d-flex align-items-center justify-content-center"
        style="z-index:1055;">
        <div class="bg-white rounded p-4" style="width:90%;max-width:24rem;">
            <p id="confirmMessage" class="mb-4"></p>
            <div class="d-flex justify-content-end gap-3">
                <button id="confirmCancel" class="btn btn-secondary">Cancel</button>
                <button id="confirmOk" class="btn btn-primary">Confirm</button>
            </div>
        </div>
    </div>

</body>

</html>